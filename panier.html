<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mon Panier</title>
    <link rel="stylesheet" href="style/panier.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="style/theme.css">
</head>
<body>

    <header class="site-header">
        <div class="logo">FUCK THE MODE</div>
        <nav class="site-nav">
            <a href="index.html"><i class="fa-solid fa-arrow-left"></i> Continuer mes achats</a>
            <div class="cart-icon-container" style="display:inline-block; position:relative; margin-left:20px;">
                <i class="fa-solid fa-basket-shopping"></i>
                <span id="cart-count">0</span>
            </div>
        </nav>
    </header>

    <main class="cart-container">
        <h1>Votre Panier</h1>
        <div class="cart-items" id="cart-items-container">
            </div>

        <div class="cart-total">
            <div class="promo-section">
                <input type="text" id="promo-code" class="promo-input" placeholder="Code Promo">
                <button onclick="checkPromo()" class="promo-btn">APPLIQUER</button>
            </div>
            <p id="promo-msg" class="promo-message"></p>

            <div class="total-row"><span>SOUS-TOTAL</span><span id="subtotal">0.00 $</span></div>
            
            <div class="total-row" id="discount-row" style="display:none; color:#00ff00;">
                <span>RABAIS (<span id="promo-name"></span>)</span>
                <span id="discount-amount">-0.00 $</span>
            </div>

            <hr>
            <div class="total-row final"><span>TOTAL (H.T.)</span><span id="grand-total">0.00 $</span></div>
            
            <button onclick="window.location.href='paiement.html'" class="checkout-btn">PASSER AU PAIEMENT</button>
        </div>
    </main>

    <footer class="site-footer"><p>&copy; 2025 FUCK THE MODE.</p></footer>

    <script src="js/data.js"></script>
    <script src="js/cart.js"></script>
    <script>
        const container = document.getElementById('cart-items-container');
        let cart = JSON.parse(localStorage.getItem('productsInCart')) || {};
        let subTotal = 0;

        // 1. LISTE DES CODES PROMOS
        const PROMO_CODES = {
            "FTM": 0.15,
            "PA": 0.10,
            "ELA": 0.07,
            "MUS": 0.05,
            "GLO": 0.50
        };

        // AFFICHER LE PANIER
        if (Object.keys(cart).length === 0) {
            container.innerHTML = "<p class='empty-msg'>Votre panier est vide.</p>";
        } else {
            Object.keys(cart).forEach(uniqueKey => {
                let splitKey = uniqueKey.split('-');
                let product = productsDB[splitKey[0]];
                if(product) {
                    let quantity = cart[uniqueKey];
                    let linePrice = getPrice(product.price) * quantity;
                    subTotal += linePrice;

                    container.innerHTML += `
                        <div class="cart-item">
                            <div class="item-img"><img src="${product.img}"></div>
                            <div class="item-details">
                                <h3>${product.title}</h3>
                                <p class="unit-price">${product.price}</p>
                                <p style="color:#aaa; font-size:0.9rem;">Taille : <strong style="color:white;">${splitKey[1]}</strong></p>
                                <div class="qty-control"><span>Quantité : <strong>${quantity}</strong></span></div>
                            </div>
                            <div class="item-actions">
                                <div class="item-total">${linePrice.toFixed(2)} $</div>
                                <div class="delete-btn" onclick="deleteItem('${uniqueKey}')"><i class="fa-solid fa-trash"></i> Supprimer</div>
                            </div>
                        </div>
                    `;
                }
            });
        }

        // GESTION DU RABAIS
        let currentDiscount = 0;
        let savedPromo = getActivePromo(); // Récupère du localStorage s'il y en a un

        if (savedPromo) {
            document.getElementById('promo-code').value = savedPromo.code;
            applyDiscountDisplay(savedPromo.discount, savedPromo.code);
        } else {
            updateTotalsDisplay();
        }

        function checkPromo() {
            let code = document.getElementById('promo-code').value.toUpperCase().trim();
            let msg = document.getElementById('promo-msg');

            if (PROMO_CODES[code]) {
                msg.innerText = "Code appliqué : " + (PROMO_CODES[code] * 100) + "% de rabais !";
                msg.className = "promo-message text-success";
                
                // Sauvegarde dans le localStorage
                applyPromoToStorage(PROMO_CODES[code], code);
                
                // Mise à jour affichage
                applyDiscountDisplay(PROMO_CODES[code], code);
            } else {
                msg.innerText = "Code invalide.";
                msg.className = "promo-message text-error";
                
                // Annuler le rabais
                localStorage.removeItem('activePromo');
                currentDiscount = 0;
                document.getElementById('discount-row').style.display = "none";
                updateTotalsDisplay();
            }
        }

        function applyDiscountDisplay(percentage, codeName) {
            currentDiscount = percentage;
            document.getElementById('discount-row').style.display = "flex";
            document.getElementById('promo-name').innerText = codeName;
            updateTotalsDisplay();
        }

        function updateTotalsDisplay() {
            let discountAmount = subTotal * currentDiscount;
            let finalTotal = subTotal - discountAmount;

            document.getElementById('subtotal').innerText = subTotal.toFixed(2) + " $";
            document.getElementById('discount-amount').innerText = "-" + discountAmount.toFixed(2) + " $";
            document.getElementById('grand-total').innerText = finalTotal.toFixed(2) + " $";
        }
    </script>
    <script src="js/theme.js"></script>
</body>
</html>