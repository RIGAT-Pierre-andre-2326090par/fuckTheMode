<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Paiement Sécurisé</title>
    <link rel="stylesheet" href="style/paiement.css">
    <link rel="stylesheet" href="style/theme.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <header class="site-header">
        <div class="logo">FUCK THE MODE</div>
        <nav class="site-nav"><a href="panier.html"><i class="fa-solid fa-arrow-left"></i> Retour au panier</a></nav>
    </header>
    <main class="checkout-container">
        <section class="cart-summary">
            <h2 class="section-title">Récapitulatif</h2>
            <div class="cart-grid" id="checkout-items"></div>
            
            <hr class="separator">
            
            <div class="tax-row"><span>Sous-total</span><span id="summary-subtotal">0.00 $</span></div>
            <div class="tax-row" id="summary-discount-row" style="display:none; color:#00ff00;"><span>Rabais</span><span id="summary-discount">-0.00 $</span></div>
            <div class="tax-row"><span>TPS (5%)</span><span id="summary-tps">0.00 $</span></div>
            <div class="tax-row"><span>TVQ (9.975%)</span><span id="summary-tvq">0.00 $</span></div>
            
            <div class="total-line">
                <span>TOTAL À PAYER :</span>
                <span class="total-price" id="checkout-total">0.00 $</span>
            </div>
        </section>

        <hr class="separator">

        <section class="checkout-form">
            <h2 class="section-title">Paiement</h2>
            <form onsubmit="finishOrder(event)">
                <div class="form-group"><label>Nom complet</label><input type="text" required></div>
                <div class="form-group"><label>Email</label><input type="email" required></div>
                <div class="form-group"><label>Carte Bancaire</label><div class="input-icon"><i class="fa-solid fa-credit-card"></i><input type="text" placeholder="0000 0000 0000 0000" required></div></div>
                <div class="row"><div class="form-group half"><label>Expiration</label><input type="text" placeholder="MM/AA" required></div><div class="form-group half"><label>CVC</label><input type="text" placeholder="123" required></div></div>
                <button type="submit" class="pay-btn">PAYER MAINTENANT</button>
            </form>
        </section>
    </main>

    <script src="js/data.js"></script>
    <script src="js/cart.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/theme.js"></script>
    <script>
        const container = document.getElementById('checkout-items');
        let cart = JSON.parse(localStorage.getItem('productsInCart')) || {};
        
        // CALCULS FINANCIERS
        let subTotal = 0;
        let discountPercent = 0;
        
        // Récupérer le rabais du localStorage
        let activePromo = getActivePromo();
        if (activePromo) {
            discountPercent = activePromo.discount;
        }

        if (Object.keys(cart).length === 0) {
            container.innerHTML = "<p>Votre panier est vide.</p>";
            document.querySelector('.pay-btn').disabled = true;
        } else {
            Object.keys(cart).forEach(uniqueKey => {
                let splitKey = uniqueKey.split('-');
                let product = productsDB[splitKey[0]];
                if(product){
                    let quantity = cart[uniqueKey];
                    let linePrice = getPrice(product.price) * quantity;
                    subTotal += linePrice;

                    container.innerHTML += `
                        <div class="cart-item">
                            <div class="img-box"><img src="${product.img}"></div>
                            <div class="item-info">
                                <div><h3>${product.title} (x${quantity})</h3><p style="font-size:0.8rem; color:#aaa;">Taille : ${splitKey[1]}</p></div>
                                <p class="price">${linePrice.toFixed(2)} $</p>
                            </div>
                        </div>
                    `;
                }
            });

            // CALCULS TAXES QUEBEC
            let discountAmount = subTotal * discountPercent;
            let priceAfterDiscount = subTotal - discountAmount;
            
            let tps = priceAfterDiscount * 0.05;
            let tvq = priceAfterDiscount * 0.09975;
            let finalTotal = priceAfterDiscount + tps + tvq;

            // AFFICHAGE
            document.getElementById('summary-subtotal').innerText = subTotal.toFixed(2) + " $";
            
            if (discountAmount > 0) {
                document.getElementById('summary-discount-row').style.display = "flex";
                document.getElementById('summary-discount').innerText = "-" + discountAmount.toFixed(2) + " $";
            }

            document.getElementById('summary-tps').innerText = tps.toFixed(2) + " $";
            document.getElementById('summary-tvq').innerText = tvq.toFixed(2) + " $";
            document.getElementById('checkout-total').innerText = finalTotal.toFixed(2) + " $";
        }

        function finishOrder(e) {
            e.preventDefault();
            let currentUser = localStorage.getItem('currentUser');
            if (!currentUser) { alert("Connectez-vous !"); window.location.href = "connexion.html"; return; }
            
            // On recalcule le total exact pour l'historique
            let finalTotalText = document.getElementById('checkout-total').innerText;
            let itemsCount = 0;
            Object.values(cart).forEach(qty => itemsCount += qty);

            addOrderToHistory(finalTotalText, itemsCount);
            alert("Paiement validé !");
            clearCart();
            localStorage.removeItem('activePromo'); // On vide le code promo après usage
            window.location.href = "compte.html";
        }
    </script>
</body>
</html>